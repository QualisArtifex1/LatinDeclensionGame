<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Latin Declension Drag & Drop — Ancient Theme</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    /* ========================
       Ancient shared palette
       ======================== */
    :root{
      --primary: #8b4513;   /* Roman brown */
      --primary-600:#6f3710;
      --accent:  #c19a6b;   /* parchment gold */
      --ink:     #2e2a27;   /* text */
      --ink-2:   #5a4e45;   /* secondary text */
      --bg-deep: #2b241d;   /* page backdrop (behind parchment panels) */
      --panel-a: #fffaf0;   /* parchment top */
      --panel-b: #f4ead6;   /* parchment bottom */
      --border:  #d1b792;   /* parchment edge */

      --ok:   #3a7a3a;  /* success */
      --warn: #c38c1d;  /* warning */
      --bad:  #9c2f2f;  /* error */

      --radius: 16px;
      --shadow: 0 10px 28px rgba(0,0,0,.18);
      --cell-min: 56px;
      --gap: 12px;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg-deep);
      color: var(--ink);
      margin:0; display:flex; flex-direction:column; align-items:center;
      overflow-x:hidden;
    }

    /* Ancient ambience (fixed background layer) */
    .bg{position:fixed; inset:0; z-index:0; overflow:hidden}
    .bg img{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:110%; height:auto; max-height:110%; object-fit:contain; filter:contrast(1.02) saturate(0.95)}
    .vignette,.grain,.torch{position:absolute; inset:0; pointer-events:none}
    .vignette{z-index:1; background:radial-gradient(120vmax 80vmax at 50% 55%, rgba(0,0,0,0) 55%, rgba(0,0,0,0.35) 100%); mix-blend-mode:multiply}
    .grain{z-index:2; opacity:.18; mix-blend-mode:overlay; background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='0.55'/></svg>"); background-size:140px 140px; animation:grainShift 9s linear infinite}
    @keyframes grainShift{from{transform:translate3d(0,0,0)} to{transform:translate3d(-140px,-140px,0)}}
    .torch{z-index:3; --x:50%; --y:40%; --r1:10vmin; --r2:40vmin; background:radial-gradient(circle at var(--x) var(--y), rgba(255,240,200,0.20) 0, rgba(255,215,160,0.12) var(--r1), rgba(0,0,0,0) var(--r2)); mix-blend-mode:soft-light; animation:torchFlicker 2.4s ease-in-out infinite}
    @keyframes torchFlicker{0%{filter:brightness(1) blur(.1px)}50%{filter:brightness(1.06) blur(.2px)}100%{filter:brightness(1) blur(.1px)}}
    canvas#dust{position:absolute; inset:0; z-index:4; pointer-events:none; mix-blend-mode:screen}

    /* App containers over ambience */
    header{ position:sticky; top:0; width:100%; z-index: 10; background: linear-gradient(180deg, rgba(0,0,0,.06), transparent 70%); backdrop-filter: blur(4px); }
    .topbar{ max-width: 1100px; margin: 0 auto; padding: 14px 16px; display:flex; gap:12px; align-items:center; }
    .brand{ display:flex; align-items:baseline; gap:10px; }
    .brand h1{ font-family:'Cinzel', serif; font-weight:700; letter-spacing:.5px; margin:0; font-size: clamp(18px, 2.4vw, 28px); color:var(--accent); text-shadow:0 1px 0 rgba(0,0,0,.15)}
    .brand .tag{ font-size:12px; padding:4px 8px; border-radius:999px; background:var(--primary); color:#fff; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.1) }

    .spacer{ flex:1; }

    .controls{ display:flex; gap:8px; align-items:center; }
    button, .btn{ font: inherit; font-weight:700; border:1px solid transparent; color:#fff; background:var(--primary); padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: var(--shadow); transition: transform .06s ease, background .2s ease; }
    button:hover{ background: var(--primary-600); }
    button:active{ transform: translateY(1px); }
    .btn-ghost{ background:transparent; color:#f7efe0; border-color:rgba(209,183,146,.55); box-shadow:none; border:1px dashed var(--border) }
    .btn-ghost:hover{ background: rgba(255,255,255,.06); }

    main{ width:100%; max-width:1100px; padding: 12px 16px 32px; position:relative; z-index:5 }

    .card{ background:linear-gradient(180deg, var(--panel-a), var(--panel-b)); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }

    #selection{ padding:18px; display:grid; gap:16px; margin-top:8px; }
    #selection h2{ font-family:'Cinzel', serif; margin:0; font-size: clamp(18px,2.2vw,24px); color:var(--primary) }
    .declensions{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.35); cursor:pointer; user-select:none; transition: background .2s ease, border-color .2s ease, transform .06s; }
    .pill input{ appearance:none; width:0; height:0; }
    .pill.active{ background: rgba(139,69,19,.12); border-color: var(--primary); }
    .hint{ color: var(--ink-2); font-size: 14px; }

    .footer-actions{ display:flex; gap:10px; justify-content:flex-end; }

    #game.card{ margin-top:14px; padding:14px; display:grid; gap:14px; }

    .hud{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; }
    .stat{ display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,.45); }
    .stat strong{ font-variant-numeric: tabular-nums; }

    .progress{ position:relative; height:10px; background:#e5d8b8; border-radius:999px; overflow:hidden; border:1px solid var(--border) }
    .progress>span{ position:absolute; inset:0; width:0%; background: linear-gradient(90deg, var(--primary), var(--accent)); }

    .board-wrap{ display:grid; gap: var(--gap); }
    .board{ overflow:auto; border:1px solid var(--border); border-radius: var(--radius); background:linear-gradient(180deg, #fffaf0, #f7edd6) }
    #board-scale{ transform-origin: top left; will-change: transform; }

    table{ width:100%; border-collapse: separate; border-spacing:0; table-layout: fixed; font-size: clamp(16px, 2.4vw, 18px); }
    thead th{ position:sticky; top:0; background: linear-gradient(180deg, #fff5e1, #f1e1bf); z-index:1; }
    th, td{ border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:12px; min-width: var(--cell-min); height:60px; text-align:center; }
    th:first-child, td:first-child{ position:sticky; left:0; background: linear-gradient(180deg, #fff5e1, #f1e1bf); z-index: 1; }

    .row-head{ font-weight:700; }
    .row-head .bar{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px; vertical-align:middle; }
    .c-nom { --c:#9c2f2f; } .c-gen { --c:#3a7a3a; } .c-dat { --c:#c38c1d; } .c-acc { --c:#2f5f96; } .c-abl { --c:#8b3f7a; }
    .row-head .bar{ background: var(--c); }

    .dropzone{ background: linear-gradient(180deg, transparent, rgba(0,0,0,.02)); border-radius:8px; transition: background .15s ease, box-shadow .15s ease, transform .06s; }
    .dropzone:empty::after{ content:""; }
    .dropzone.drag-over{ outline:2px dashed var(--primary); outline-offset:-6px; background: rgba(139,69,19,.08); }

    .tray{ display:grid; grid-template-columns: 1fr; gap: var(--gap); align-items:center; }
    @media (min-width: 900px){ .tray{ grid-template-columns: 320px 1fr; } }

    .tile-area{ display:grid; gap:10px; align-items:center; justify-items:center; }
    .tile{ background: linear-gradient(180deg, var(--panel-a), var(--panel-b)); border:2px solid var(--primary); border-radius: 18px; box-shadow: var(--shadow); width: min(20vw, 200px); height: min(20vw, 200px); max-width: 220px; max-height: 220px; min-width: 100px; min-height: 100px; display:flex; align-items:center; justify-content:center; font-size: clamp(24px, 5vw, 44px); font-weight:700; user-select:none; touch-action:none; cursor: grab; position: relative; transition: transform .06s ease; }
    .tile:active{ cursor: grabbing; transform: scale(.98); }

    .queue{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .chip{ padding:10px 12px; border:1px dashed var(--border); border-radius:10px; min-width:46px; text-align:center; opacity:.8; font-size: 1.05em; background:rgba(255,255,255,.35) }

    .actions{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }
    .btn-ok{ background:var(--ok); }
    .btn-warn{ background:var(--warn); color:#111; }
    .btn-ghost.bad{ color: var(--bad); border-color: rgba(156,47,47,.5); }

    .toast{ position: fixed; bottom:14px; left:50%; transform: translateX(-50%); background: #111; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; pointer-events:none; transition: opacity .2s, transform .2s; }
    .toast.show{ opacity:1; transform: translate(-50%, -6px); }

    dialog{ border:none; padding:0; width:min(560px, 92vw); border-radius: 18px; overflow:hidden; background:linear-gradient(180deg, var(--panel-a), var(--panel-b)); box-shadow: var(--shadow); border:1px solid var(--border) }
    dialog::backdrop{ background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }
    .modal-head{ padding:16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; font-family:'Cinzel',serif }
    .modal-body{ padding:16px; display:grid; gap:12px; }

    :focus-visible{ outline: 3px solid var(--primary); outline-offset: 2px; border-radius: 6px; }
  </style>
</head>
<body>
  <!-- Ambient layer (matches your homepage) -->
  <div class="bg" aria-hidden="true">
    <img src="qualis-artifex-logo.png" alt="" />
    <div class="vignette"></div>
    <div class="grain"></div>
    <div class="torch"></div>
    <canvas id="dust"></canvas>
  </div>

  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Latin Declension Practice</h1>
        <span class="tag">v2</span>
      </div>
      <div class="spacer"></div>
      <div class="controls">
        <!-- removed theme toggle -->
        <button class="btn-ghost" id="open-help" aria-haspopup="dialog">Help</button>
        <button id="reset-all" class="btn-ghost bad" title="Clear board & restart">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <section id="selection" class="card" aria-labelledby="sel-h2">
      <h2 id="sel-h2">Choose Declensions</h2>
      <div class="declensions" id="declension-pills" role="group" aria-label="Declension choices"></div>
      <div class="hint">Tip: you can mix sets (e.g., 1st + 3rd) for spaced practice.</div>
      <div class="footer-actions">
        <button id="btn-start">Start Practice</button>
      </div>
    </section>

    <section id="game" class="card" hidden>
      <div class="hud">
        <div class="stat" aria-live="polite">⏱️ <strong id="time">0:00</strong></div>
        <div class="stat">💡 Hints: <strong id="hints">0</strong></div>
        <div class="stat">🎯 Remaining: <strong id="remain">—</strong></div>
        <div class="stat" style="flex:1 1 220px; min-width:220px">
          <div class="progress" aria-label="Progress"><span id="progress"></span></div>
        </div>
        <div class="spacer"></div>
        <div class="actions">
          <button id="btn-hint" class="btn-warn" title="Fill one correct cell">Hint</button>
          <button id="btn-check" class="btn-ok">Check</button>
          <button id="btn-restart" class="btn-ghost">Restart</button>
        </div>
      </div>

      <div class="tray">
        <div class="tile-area">
          <div id="tile" class="tile" role="button" aria-label="Current ending" tabindex="0"></div>
          <div class="queue" aria-live="polite" aria-atomic="true">
            <div class="chip" id="q1">—</div>
            <div class="chip" id="q2">—</div>
            <div class="chip" id="q3">—</div>
          </div>
          <div class="hint" id="placement-hint">Drag the large tile, or tap a cell to place it.</div>
        </div>

        <div class="board-wrap">
          <div class="board" id="board" role="region" aria-label="Declension table">
            <div id="board-scale">
              <table>
                <thead>
                  <tr id="thead-row"><th>Case</th></tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <dialog id="help-modal" aria-labelledby="help-title">
    <div class="modal-head"><strong id="help-title">How it works</strong></div>
    <div class="modal-body">
      <ol>
        <li>Pick your declensions, then press <em>Start Practice</em>.</li>
        <li>Drag the big tile onto the correct cell, or tap a cell to place it.</li>
        <li>Press <em>Check</em> to clear any wrong cells and keep going.</li>
        <li>Use <em>Hint</em> if you get stuck — it fills one correct cell.</li>
      </ol>
      <p>Keyboard: focus the table cells with <kbd>Tab</kbd>, press <kbd>Enter</kbd> to drop the current tile.</p>
      <div style="text-align:right; padding-top:8px">
        <button class="btn-ghost" id="close-help">Close</button>
      </div>
    </div>
  </dialog>

  <dialog id="finish-modal" aria-labelledby="finish-title">
    <div class="modal-head"><strong id="finish-title">Well done! 🎉</strong></div>
    <div class="modal-body">
      <p><strong>Total time:</strong> <span id="final-time"></span></p>
      <p><strong>Best time for this mix:</strong> <span id="best-time">—</span></p>
      <div style="display:flex; gap:8px; justify-content:flex-end; padding-top:6px">
        <button id="play-again" class="btn-ok">Play again</button>
        <button id="close-finish" class="btn-ghost">Close</button>
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
  (function(){
    // ===== Ambience: Dust motes =====
    let dustCtx=null, dustCanvas=null, dustRAF=null, motes=null, dpr=1; let W=0, H=0;
    function dustSize(){ if(!dustCanvas||!dustCtx) return; dpr=Math.min(window.devicePixelRatio||1,2); W=innerWidth; H=innerHeight; dustCanvas.width=W*dpr; dustCanvas.height=H*dpr; dustCtx.setTransform(dpr,0,0,dpr,0,0); }
    function startDust(){ if(dustCtx) return; dustCanvas=document.getElementById('dust'); if(!dustCanvas) return; dustCtx=dustCanvas.getContext('2d'); motes=[]; dustSize(); addEventListener('resize',dustSize); const N=90; function reset(p){ p.x=Math.random()*W; p.y=Math.random()*H; p.r=Math.random()*2.0+0.7; p.a=Math.random()*Math.PI*2; p.s=(Math.random()*0.3+0.05); p.o=Math.random()*0.35+0.25; p.color=Math.random()>0.5?'#fff7d6':'#fceabb'; } for(let i=0;i<N;i++){ let p={}; reset(p); motes.push(p);} (function tick(){ if(!dustCtx) return; dustCtx.clearRect(0,0,W,H); for(const p of motes){ p.a+=(Math.random()-0.5)*0.05; p.x+=Math.cos(p.a)*p.s; p.y+=Math.sin(p.a)*p.s*0.6; if(p.x<-10||p.x>W+10||p.y<-10||p.y>H+10){ reset(p);} dustCtx.globalAlpha=p.o; dustCtx.beginPath(); dustCtx.arc(p.x,p.y,p.r,0,Math.PI*2); dustCtx.closePath(); dustCtx.fillStyle=p.color; dustCtx.shadowBlur=10; dustCtx.shadowColor=p.color; dustCtx.fill(); dustCtx.shadowBlur=0;} dustRAF=requestAnimationFrame(tick); })(); }
    startDust();

    // ===== Data =====
    const DECL_LABELS = ["1","2","2n","3","3n","4","4n","5"]; // columns
    const CANON_ORDER = [0,1,2,3,4,5,6,7];
    const CASE_LABELS = ['Nominative','Genitive','Dative','Accusative','Ablative','Nominative-P','Genitive-P','Dative-P','Accusative-P','Ablative-P'];
    const CASE_CLASS  = ['c-nom','c-gen','c-dat','c-acc','c-abl','c-nom','c-gen','c-dat','c-acc','c-abl'];

    // Matrix of endings [row][decl]
    const CORRECT = [
      ["a","us/r","um","*","*","us","u","es"],
      ["ae","i","i","is","is","us","us","ei"],
      ["ae","o","o","i","i","ui","u","ei"],
      ["am","um","um","em","*","um","u","em"],
      ["a","o","o","e","e","u","u","e"],
      ["ae","i","a","es","a","us","ua","es"],
      ["arum","orum","orum","um","um","uum","uum","erum"],
      ["is","is","is","ibus","ibus","ibus","ibus","ebus"],
      ["as","os","a","es","a","us","ua","es"],
      ["is","is","is","ibus","ibus","ibus","ibus","ebus"]
    ];

    // ===== State =====
    let selected = new Set([0,1,3]);
    let answers = []; let pool = []; let queue = []; let correctCount = 0;
    let timer = 0; let timerId = null; let running = false;
    let hintsUsed = 0; const HINT_PENALTY_SEC = 10; const HINT_COOLDOWN_SEC = 10;

    // ===== Elements =====
    const selCard = document.getElementById('selection');
    const pillsWrap = document.getElementById('declension-pills');
    const btnStart = document.getElementById('btn-start');

    const gameCard = document.getElementById('game');
    const timeEl = document.getElementById('time');
    const remainEl = document.getElementById('remain');
    const progressBar = document.getElementById('progress');

    const hintsEl = document.getElementById('hints');

    const tileEl = document.getElementById('tile');
    const q1 = document.getElementById('q1');
    const q2 = document.getElementById('q2');
    const q3 = document.getElementById('q3');

    const theadRow = document.getElementById('thead-row');
    const tbody = document.getElementById('tbody');

    const btnCheck = document.getElementById('btn-check');
    const btnRestart = document.getElementById('btn-restart');
    const btnHint = document.getElementById('btn-hint');
    const btnResetAll = document.getElementById('reset-all');

    const helpModal = document.getElementById('help-modal');
    const openHelp = document.getElementById('open-help');
    const closeHelp = document.getElementById('close-help');

    const finishModal = document.getElementById('finish-modal');
    const finalTime = document.getElementById('final-time');
    const bestTime = document.getElementById('best-time');
    const playAgain = document.getElementById('play-again');
    const closeFinish = document.getElementById('close-finish');

    const toast = document.getElementById('toast');

    const board = document.getElementById('board');
    const boardScale = document.getElementById('board-scale');

    // ===== Utils =====
    const fmtTime = (secs)=>{ const m = Math.floor(secs/60), s = secs%60; return `${m}:${s.toString().padStart(2,'0')}`; };
    const shuffle = (arr)=>{ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const orderedSelected = ()=> CANON_ORDER.filter(i=> selected.has(i));
    const keyForMix = ()=> `mix:${orderedSelected().join('-')}`;
    const effectiveTime = ()=> timer + hintsUsed * HINT_PENALTY_SEC;

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1300); }

    // ===== Timer =====
    function runTimer(on){
      if(on){
        if(running){ clearInterval(timerId); }
        running = true; timer = 0; timeEl.textContent = fmtTime(0);
        timerId = setInterval(()=>{ timer++; timeEl.textContent = fmtTime(effectiveTime()); }, 1000);
      } else { running = false; clearInterval(timerId); }
    }

    // ===== Selection Pills =====
    function renderPills(){
      pillsWrap.innerHTML = '';
      DECL_LABELS.forEach((lab, idx)=>{
        const pill = document.createElement('button');
        pill.type='button'; pill.className='pill' + (selected.has(idx)?' active':'');
        pill.setAttribute('aria-pressed', selected.has(idx));
        pill.innerHTML = `<input type="checkbox" ${selected.has(idx)?'checked':''} aria-hidden="true"><span>${lab}</span>`;
        pill.addEventListener('click', ()=>{
          if(selected.has(idx)) selected.delete(idx); else selected.add(idx);
          if(selected.size===0){ selected.add(idx); showToast('Select at least one set'); }
          renderPills();
        });
        pillsWrap.appendChild(pill);
      });
    }

    // ===== Board Build =====
    function buildBoard(){
      const ord = orderedSelected();
      answers = CORRECT.map(row => ord.map(c=> row[c]));
      pool = answers.flat();
      correctCount = 0; hintsUsed = 0; updateHintHUD();

      theadRow.innerHTML = '<th>Case</th>' + ord.map(c=>`<th>${DECL_LABELS[c]}</th>`).join('');

      tbody.innerHTML = '';
      answers.forEach((row, r)=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.className='row-head ' + CASE_CLASS[r];
        th.innerHTML = `<span class="bar"></span>${CASE_LABELS[r]}`; tr.appendChild(th);
        row.forEach((_, c)=>{
          const td = document.createElement('td'); td.className='dropzone'; td.tabIndex = 0; td.dataset.r=r; td.dataset.c=c; td.setAttribute('aria-label', `${CASE_LABELS[r]} column ${DECL_LABELS[ord[c]]}`);
          tbody.appendChild(tr); tr.appendChild(td);
        });
      });

      tbody.querySelectorAll('.dropzone').forEach(td =>{
        td.addEventListener('dragover', e=> e.preventDefault());
        td.addEventListener('pointerenter', ()=> td.classList.add('drag-over'));
        td.addEventListener('pointerleave', ()=> td.classList.remove('drag-over'));
        td.addEventListener('click', ()=> placeInCell(td));
        td.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); placeInCell(td); }});
      });

      requestAnimationFrame(fitBoardToScreen);
      updateHUD();
    }

    // ===== Game Flow =====
    function startGame(){
      queue = shuffle(pool); updateQueue(); runTimer(true); requestAnimationFrame(fitBoardToScreen); updateHUD();
      enableHint(true);
    }

    function updateHUD(){
      const total = answers.flat().length;
      remainEl.textContent = queue.length;
      const pct = Math.round(100 * (correctCount / total));
      progressBar.style.width = pct + '%';
      timeEl.textContent = fmtTime(effectiveTime());
    }

    function updateHintHUD(){ hintsEl.textContent = `${hintsUsed}`; }

    function updateQueue(){
      if(queue.length===0){ tileEl.textContent=''; q1.textContent=q2.textContent=q3.textContent='—'; return; }
      const [current, ...rest] = queue; tileEl.textContent = current; q1.textContent = rest[0] ?? '—'; q2.textContent = rest[1] ?? '—'; q3.textContent = rest[2] ?? '—';
    }

    function nextTile(){ queue.shift(); updateQueue(); updateHUD(); }

    function placeInCell(td){
      const val = tileEl.textContent?.trim(); if(!val) return;
      const prev = td.textContent.trim(); if(prev){ queue.push(prev); }
      td.textContent = val; td.style.background=''; td.style.boxShadow='';
      nextTile();
    }

    // ===== Check answers =====
    function checkAnswers(){
      const tds = [...tbody.querySelectorAll('.dropzone')];
      const wrongVals = []; correctCount = 0;
      tds.forEach(td=>{
        const txt = td.textContent.trim(); const r = +td.dataset.r, c = +td.dataset.c; const correct = answers[r][c].toLowerCase();
        if(!txt){ td.style.background=''; td.style.boxShadow=''; return; }
        if(txt.toLowerCase() === correct){
          correctCount++; td.style.background='rgba(58,122,58,.10)'; td.style.boxShadow='inset 0 0 0 2px rgba(58,122,58,.35)';
        } else { td.textContent=''; td.style.background=''; td.style.boxShadow=''; wrongVals.push(txt); }
      });
      if(wrongVals.length){ queue = shuffle(queue.concat(wrongVals)); updateQueue(); showToast(`${wrongVals.length} corrected`); }

      const total = answers.flat().length;
      if(correctCount === total){
        runTimer(false);
        const usedAsterisk = hintsUsed>0 ? '*' : '';
        const tEff = effectiveTime();
        finalTime.textContent = `${fmtTime(tEff)}${usedAsterisk}${hintsUsed?` (base ${fmtTime(timer)}, +${hintsUsed*HINT_PENALTY_SEC}s)`:''}`;
        const key = keyForMix();
        const prevBest = +localStorage.getItem(key) || Infinity;
        if(tEff < prevBest){ localStorage.setItem(key, String(tEff)); }
        bestTime.textContent = isFinite(+localStorage.getItem(key)) ? `${fmtTime(+localStorage.getItem(key))}${(+localStorage.getItem(key)===tEff && hintsUsed>0?'*':'')}` : '—';
        finishModal.showModal();
        confetti({ particleCount: 200, spread: 70, origin:{ y:.6 } });
      }
      updateHintHUD(); updateHUD();
    }

    // ===== Hint (penalty + cooldown) =====
    let hintCooldownId = null; let hintCooldownLeft = 0;
    function enableHint(on){
      btnHint.disabled = !on; btnHint.textContent = on ? 'Hint' : `Hint (${hintCooldownLeft}s)`;
    }
    function tickHintCooldown(){
      hintCooldownLeft--; if(hintCooldownLeft<=0){ clearInterval(hintCooldownId); hintCooldownId=null; enableHint(true); }
      else { btnHint.textContent = `Hint (${hintCooldownLeft}s)`; }
    }
    function startHintCooldown(){
      hintCooldownLeft = HINT_COOLDOWN_SEC; enableHint(false);
      hintCooldownId = setInterval(tickHintCooldown, 1000);
    }

    function useHint(){
      if(btnHint.disabled) return; // safety
      const empties = [...tbody.querySelectorAll('.dropzone')].filter(td=>!td.textContent);
      if(empties.length===0){ showToast('No empty cells.'); return; }
      const td = empties[Math.floor(Math.random()*empties.length)];
      const r = +td.dataset.r, c = +td.dataset.c; const val = answers[r][c];
      const qi = queue.findIndex(x=> x.toLowerCase()===val.toLowerCase()); if(qi>=0){ queue.splice(qi,1); }
      td.textContent = val; td.style.background='rgba(139,69,19,.10)'; td.style.boxShadow='inset 0 0 0 2px rgba(139,69,19,.35)';
      hintsUsed++; showToast(`Hint used (+${HINT_PENALTY_SEC}s)`);
      startHintCooldown(); updateQueue(); updateHintHUD(); updateHUD();
    }

    // Restart keeps same mix
    function restart(){ buildBoard(); startGame(); }

    // Reset all returns to selection
    function resetAll(){ if(!confirm('Clear the board and return to selection?')) return; runTimer(false); gameCard.hidden = true; selCard.hidden = false; requestAnimationFrame(fitBoardToScreen); }

    // Drag with pointer
    let dragging = false; let offsetX=0, offsetY=0;
    tileEl.addEventListener('pointerdown', (e)=>{ dragging = true; tileEl.setPointerCapture(e.pointerId); tileEl.style.cursor='grabbing'; const rect = tileEl.getBoundingClientRect(); offsetX = e.clientX - rect.left; offsetY = e.clientY - rect.top; tileEl.style.position='fixed'; moveTile(e.clientX, e.clientY); });
    window.addEventListener('pointermove', (e)=>{ if(!dragging) return; moveTile(e.clientX, e.clientY); });
    window.addEventListener('pointerup', (e)=>{ if(!dragging) return; dragging=false; tileEl.releasePointerCapture?.(e.pointerId); tileEl.style.cursor='grab'; tileEl.style.position=''; tileEl.style.left=''; tileEl.style.top=''; tileEl.style.visibility='hidden'; const target = document.elementFromPoint(e.clientX, e.clientY); tileEl.style.visibility='visible'; const td = target?.closest?.('.dropzone'); if(td) placeInCell(td); });
    function moveTile(x,y){ tileEl.style.left = (x - offsetX) + 'px'; tileEl.style.top = (y - offsetY) + 'px'; }

    // ===== Mobile fit-to-screen (fit width, scroll height) =====
    const isMobile = matchMedia('(pointer:coarse)').matches || /Mobi|Android/i.test(navigator.userAgent);
    function fitBoardToScreen(){
      if(!isMobile){ boardScale.style.transform = ''; board.style.height = ''; board.style.overflow = 'auto'; return; }
      const natW = boardScale.scrollWidth; const natH = boardScale.scrollHeight; const rect = board.getBoundingClientRect();
      const availW = Math.max(320, window.innerWidth - 16); const scaleW = Math.min(availW / natW, 1); boardScale.style.transform = `scale(${scaleW})`;
      const availH = Math.max(240, window.innerHeight - rect.top - 12); board.style.height = Math.min(natH * scaleW, availH) + 'px'; board.style.overflow = 'auto'; }
    window.addEventListener('resize', ()=> requestAnimationFrame(fitBoardToScreen));

    // Buttons
    btnStart.addEventListener('click', ()=>{ if(selected.size===0){ showToast('Select at least one set'); return; } selCard.hidden = true; gameCard.hidden = false; buildBoard(); startGame(); localStorage.setItem('lastSelected', JSON.stringify([...selected])); });
    btnCheck.addEventListener('click', checkAnswers);
    btnRestart.addEventListener('click', ()=>{ restart(); requestAnimationFrame(fitBoardToScreen); });
    btnResetAll.addEventListener('click', resetAll);
    btnHint.addEventListener('click', useHint);

    openHelp.addEventListener('click', ()=> helpModal.showModal()); closeHelp.addEventListener('click', ()=> helpModal.close());
    playAgain.addEventListener('click', ()=>{ finishModal.close(); restart(); requestAnimationFrame(fitBoardToScreen); });
    closeFinish.addEventListener('click', ()=> finishModal.close());

    // Persist last selection
    const last = localStorage.getItem('lastSelected'); if(last){ try{ selected = new Set(JSON.parse(last)); }catch{} }
    renderPills();

    // ===== Minimal Self-tests (console) =====
    (function selfTests(){
      try{ console.group('%cSelf-tests','color:#8b4513;font-weight:bold');
        console.assert(Array.isArray(CORRECT) && CORRECT.length===10, '10 case rows');
        console.assert(CORRECT.every(r=>Array.isArray(r) && r.length===8), '8 decl columns');
        const prevSel = new Set(selected); selected = new Set([3,0,5]); buildBoard();
        const headers = [...document.querySelectorAll('#thead-row th')].slice(1).map(th=>th.textContent.trim());
        console.assert(headers.join(',')==='1,3,4', 'Canonical order for subset'); selected = prevSel; buildBoard();
        console.groupEnd(); } catch(e){ console.error('Self-tests failed:', e); }
    })();

  })();
  </script>
</body>
</html>
